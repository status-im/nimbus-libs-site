<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Eth | Nimbus Libraries</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/img/logo.png">
    <meta name="description" content="Ethereum 2.0 utilities and more">
    
    <link rel="preload" href="/assets/css/0.styles.74783a08.css" as="style"><link rel="preload" href="/assets/js/app.7b0ccc3e.js" as="script"><link rel="preload" href="/assets/js/2.19ed51f2.js" as="script"><link rel="preload" href="/assets/js/10.7ff41305.js" as="script"><link rel="prefetch" href="/assets/js/11.f7d9575c.js"><link rel="prefetch" href="/assets/js/3.8a4d3eed.js"><link rel="prefetch" href="/assets/js/4.b9b777bd.js"><link rel="prefetch" href="/assets/js/5.073c37d9.js"><link rel="prefetch" href="/assets/js/6.7db49fe2.js"><link rel="prefetch" href="/assets/js/7.bf8b68e5.js"><link rel="prefetch" href="/assets/js/8.b8ee59fd.js"><link rel="prefetch" href="/assets/js/9.79ef4a4b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74783a08.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Nimbus Libraries" class="logo"> <span class="site-name can-hide">Nimbus Libraries</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lib/nim-chronicles/" class="nav-link">
  Chronicles
</a></div><div class="nav-item"><a href="/lib/nim-eth/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Eth
</a></div><div class="nav-item"><a href="/lib/nim-stew/" class="nav-link">
  Stew
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lib/nim-chronicles/" class="nav-link">
  Chronicles
</a></div><div class="nav-item"><a href="/lib/nim-eth/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Eth
</a></div><div class="nav-item"><a href="/lib/nim-stew/" class="nav-link">
  Stew
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Eth</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/lib/nim-eth/#rlp" class="sidebar-link">rlp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lib/nim-eth/#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#reading-rlp-data" class="sidebar-link">Reading RLP data</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#streaming-api" class="sidebar-link">Streaming API</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#dom-api" class="sidebar-link">DOM API</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#creating-rlp-data" class="sidebar-link">Creating RLP data</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#object-serialization" class="sidebar-link">Object serialization</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#optional-fields" class="sidebar-link">Optional fields</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#contributing-testing" class="sidebar-link">Contributing / Testing</a></li></ul></li><li><a href="/lib/nim-eth/#keys" class="sidebar-link">keys</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#keyfile" class="sidebar-link">keyfile</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lib/nim-eth/#introduction-2" class="sidebar-link">Introduction</a></li></ul></li><li><a href="/lib/nim-eth/#trie" class="sidebar-link">trie</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#nim-implementation-of-the-ethereum-trie-structure" class="sidebar-link">Nim Implementation of the Ethereum Trie structure</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lib/nim-eth/#hexary-trie" class="sidebar-link">Hexary Trie</a></li></ul></li><li><a href="/lib/nim-eth/#bloom-an-ethereum-bloom-filter" class="sidebar-link">bloom: an Ethereum Bloom Filter</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#introduction-3" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#description" class="sidebar-link">Description</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#node-discovery-protocol-v5" class="sidebar-link">Node Discovery Protocol v5</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lib/nim-eth/#introduction-4" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#how-to-use" class="sidebar-link">How to use</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#test-suite" class="sidebar-link">Test suite</a></li><li class="sidebar-sub-header"><a href="/lib/nim-eth/#dcli" class="sidebar-link">dcli</a></li></ul></li><li><a href="/lib/nim-eth/#prerequisites" class="sidebar-link">Prerequisites</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#building-testing" class="sidebar-link">Building &amp; Testing</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-eth/#fuzzing" class="sidebar-link">Fuzzing</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="eth"><a href="#eth" class="header-anchor">#</a> Eth</h1> <p>Ethereum-related utilities written in Nim. Includes things like Bloom filters, private/public key utilities, RLP, devp2p, and more.</p> <h2 id="rlp"><a href="#rlp" class="header-anchor">#</a> rlp</h2> <h3 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h3> <p>A Nim implementation of the Recursive Length Prefix encoding (RLP) as specified
in the Ethereum's <a href="https://ethereum.github.io/yellowpaper/paper.pdf" target="_blank" rel="noopener noreferrer">Yellow Paper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
and <a href="https://github.com/ethereum/wiki/wiki/RLP" target="_blank" rel="noopener noreferrer">Wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="reading-rlp-data"><a href="#reading-rlp-data" class="header-anchor">#</a> Reading RLP data</h3> <p>The <code>Rlp</code> type provided by this library represents a cursor over an RLP-encoded
byte stream.</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">rlpFromBytes<span class="token operator">*</span></span><span class="token punctuation">(</span>data<span class="token operator">:</span> openArray<span class="token punctuation">[</span>byte<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Rlp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="streaming-api"><a href="#streaming-api" class="header-anchor">#</a> Streaming API</h3> <p>Once created, the <code>Rlp</code> object will offer procs such as <code>isList</code>, <code>isBlob</code>,
<code>getType</code>, <code>listLen</code>, <code>blobLen</code> to determine the type of the value under
the cursor. The contents of blobs can be extracted with procs such as
<code>toString</code>, <code>toBytes</code> and <code>toInt</code> without advancing the cursor.</p> <p>Lists can be traversed with the standard <code>items</code> iterator, which will advance
the cursor to each sub-item position and yield the <code>Rlp</code> object at that point.
As an alternative, <code>listElem</code> can return a new <code>Rlp</code> object adjusted to a
particular sub-item position without advancing the original cursor.
Keep in mind that copying <code>Rlp</code> objects is cheap and you can create as many
cursors pointing to different positions in the RLP stream as necessary.</p> <p><code>skipElem</code> will advance the cursor to the next position in the current list.
<code>hasData</code> will indicate that there are no more bytes in the stream that can
be consumed.</p> <p>Another way to extract data from the stream is through the universal <code>read</code>
proc that accepts a type as a parameter. You can pass any supported type
such as <code>string</code>, <code>int</code>, <code>seq[T]</code>, etc, including composite user-defined
types (see <a href="#object-serialization">Object Serialization</a>). The cursor
will be advanced just past the end of the consumed object.</p> <p>The <code>toXX</code> and <code>read</code> family of procs may raise a <code>RlpTypeMismatch</code> in case
of type mismatch with the stream contents under the cursor. A corrupted
RLP stream or an attempt to read past the stream end will be signaled
with the <code>MalformedRlpError</code> exception. If the RLP stream includes data
that cannot be processed on the current platform (e.g. an integer value
that is too large), the library will raise an <code>UnsupportedRlpError</code> exception.</p> <h3 id="dom-api"><a href="#dom-api" class="header-anchor">#</a> DOM API</h3> <p>Calling <code>Rlp.toNodes</code> at any position within the stream will return a tree
of <code>RlpNode</code> objects representing the collection of values starting at that
position:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">type</span>
  RlpNodeType<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">enum</span>
    rlpBlob
    rlpList

  RlpNode<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span>
    <span class="token keyword">case</span> kind<span class="token operator">*:</span> RlpNodeType
    <span class="token operator">of</span> rlpBlob<span class="token operator">:</span>
      bytes<span class="token operator">*:</span> seq<span class="token punctuation">[</span>byte<span class="token punctuation">]</span>
    <span class="token operator">of</span> rlpList<span class="token operator">:</span>
      elems<span class="token operator">*:</span> seq<span class="token punctuation">[</span>RlpNode<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>As a short-cut, you can also call <code>decode</code> directly on a byte sequence to
avoid creating a <code>Rlp</code> object when obtaining the nodes.
For debugging purposes, you can also create a human readable representation
of the Rlp nodes by calling the <code>inspect</code> proc:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">inspect<span class="token operator">*</span></span><span class="token punctuation">(</span>self<span class="token operator">:</span> Rlp<span class="token punctuation">,</span> indent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">:</span> string
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="creating-rlp-data"><a href="#creating-rlp-data" class="header-anchor">#</a> Creating RLP data</h3> <p>The <code>RlpWriter</code> type can be used to encode RLP data. Instances are created
with the <code>initRlpWriter</code> proc. This should be followed by one or more calls
to <code>append</code> which is overloaded to accept arbitrary values. Finally, you can
call <code>finish</code> to obtain the final <code>seq[byte]</code>.</p> <p>If the end result should be a RLP list of particular length, you can replace
the initial call to <code>initRlpWriter</code> with <code>initRlpList(n)</code>. Calling <code>finish</code>
before writing the sufficient number of elements will then result in an assertion failure.</p> <p>As an alternative short-cut, you can also call <code>encode</code> on an arbitrary value
(including sequences and user-defined types) to execute all of the steps at
once and directly obtain the final RLP bytes. <code>encodeList(varargs)</code> is another
short-cut for creating RLP lists.</p> <h3 id="object-serialization"><a href="#object-serialization" class="header-anchor">#</a> Object serialization</h3> <p>As previously explained, generic procs such as <code>read</code>, <code>append</code>, <code>encode</code> and
<code>decode</code> can be used with arbitrary used-defined object types. By default, the
library will serialize all of the fields of the object using the <code>fields</code>
iterator, but you can also include only a subset of the fields or modify the
order of serialization or by employing the <code>rlpIgnore</code> pragma or by using the
<code>rlpFields</code> macro:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">macro</span> <span class="token function">rlpFields<span class="token operator">*</span></span><span class="token punctuation">(</span>T<span class="token operator">:</span> typedesc<span class="token punctuation">,</span> fields<span class="token operator">:</span> varargs<span class="token punctuation">[</span>untyped<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">## example usage:</span>

<span class="token keyword">type</span>
  Transaction <span class="token operator">=</span> <span class="token keyword">object</span>
    amount<span class="token operator">:</span> int
    time<span class="token operator">:</span> DateTime
    sender<span class="token operator">:</span> string
    receiver<span class="token operator">:</span> string

rlpFields Transaction<span class="token punctuation">,</span>
  sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount

<span class="token operator">...</span>

<span class="token keyword">var</span> t1 <span class="token operator">=</span> rlp<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span>Transaction<span class="token punctuation">)</span>
<span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token function">encode</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
<span class="token keyword">var</span> t2 <span class="token operator">=</span> bytes<span class="token operator">.</span><span class="token function">decode</span><span class="token punctuation">(</span>Transaction<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>In rare circumstances, you may need to serialize the same field type
differently depending on the enclosing object type. You can use the
<code>rlpCustomSerialization</code> pragma to achieve this.</p> <h3 id="optional-fields"><a href="#optional-fields" class="header-anchor">#</a> Optional fields</h3> <p>Both <code>Option[T]</code> of <code>std/options</code> and <code>Opt[T]</code> of <code>stew/results</code> are supported.
But the decoder and encoder assume optional fields are always added at the end of the RLP object.
You can never set a field to <code>None</code> unless all following fields are also <code>None</code>.</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token comment">## Example</span>

<span class="token keyword">type</span>
  RlpObject <span class="token operator">=</span> <span class="token keyword">object</span>
    size<span class="token operator">:</span> int
    color<span class="token operator">:</span> Option<span class="token punctuation">[</span>int<span class="token punctuation">]</span>
    width<span class="token operator">:</span> Opt<span class="token punctuation">[</span>int<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>If <code>color</code> is <code>none</code>, <code>width</code> should also <code>none</code>. If <code>color</code> is <code>some</code>, <code>width</code> can be both.
If <code>color</code> is <code>none</code>, but <code>width</code> is some, it will raise assertion error.</p> <h3 id="contributing-testing"><a href="#contributing-testing" class="header-anchor">#</a> Contributing / Testing</h3> <p>To test the correctness of any modifications to the library, please execute
<code>nimble test_rlp</code> at the root of the repo.</p> <h2 id="keys"><a href="#keys" class="header-anchor">#</a> keys</h2> <p>This library is a Nim re-implementation of <a href="https://github.com/ethereum/eth-keys" target="_blank" rel="noopener noreferrer">eth-keys<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the common API for working with Ethereum's public and private keys, signatures, and addresses.</p> <p>By default, Nim eth-keys uses Bitcoin's <a href="https://github.com/bitcoin-core/secp256k1" target="_blank" rel="noopener noreferrer">libsecp256k1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as a backend. Make sure libsecp256k1 is available on your system.</p> <p>An experimental pure Nim backend (Warning ⚠: do not use in production) is available with the compilation switch <code>-d:backend_native</code></p> <h2 id="keyfile"><a href="#keyfile" class="header-anchor">#</a> keyfile</h2> <h3 id="introduction-2"><a href="#introduction-2" class="header-anchor">#</a> Introduction</h3> <p>This library is a Nim reimplementation of <a href="https://github.com/ethereum/eth-keyfile" target="_blank" rel="noopener noreferrer">ethereum/eth-keyfile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which is used to create and load Ethereum <code>keyfile</code> format and the tools for handling the format and for storing private keys. Currently, the library supports only the PBKDF2 method and does not support the Scrypt method.</p> <h2 id="trie"><a href="#trie" class="header-anchor">#</a> trie</h2> <h2 id="nim-implementation-of-the-ethereum-trie-structure"><a href="#nim-implementation-of-the-ethereum-trie-structure" class="header-anchor">#</a> Nim Implementation of the Ethereum Trie structure</h2> <h3 id="hexary-trie"><a href="#hexary-trie" class="header-anchor">#</a> Hexary Trie</h3> <h2 id="bloom-an-ethereum-bloom-filter"><a href="#bloom-an-ethereum-bloom-filter" class="header-anchor">#</a> bloom: an Ethereum Bloom Filter</h2> <h2 id="introduction-3"><a href="#introduction-3" class="header-anchor">#</a> Introduction</h2> <p>A Nim implementation of the bloom filter used by Ethereum.</p> <h2 id="description"><a href="#description" class="header-anchor">#</a> Description</h2> <p><a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener noreferrer">Bloom filters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are data structures that use hash functions to test whether an element is a member of a set. They work like other data structures but are probabilistic in nature: that is, they allow false positive matches but not false negative. Bloom filters use less storage space than other data structures.</p> <p>Ethereum bloom filters are implemented with the Keccak-256 cryptographic hash function.</p> <p>To see the bloom filter used in the context of Ethereum, please refer to the <a href="https://ethereum.github.io/yellowpaper/paper.pdf" target="_blank" rel="noopener noreferrer">Ethereum Yellow Paper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">import</span> eth<span class="token operator">/</span>bloom<span class="token punctuation">,</span> stint
<span class="token keyword">var</span> f<span class="token operator">:</span> BloomFilter
f<span class="token operator">.</span><span class="token function">incl</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span>
<span class="token function">doAssert</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span> <span class="token operator">in</span> f<span class="token punctuation">)</span>
<span class="token function">doAssert</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span> <span class="token operator">notin</span> f<span class="token punctuation">)</span>
f<span class="token operator">.</span><span class="token function">incl</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span>
<span class="token function">doAssert</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span> <span class="token operator">in</span> f<span class="token punctuation">)</span>
<span class="token function">doAssert</span><span class="token punctuation">(</span>f<span class="token operator">.</span>value<span class="token operator">.</span>toHex <span class="token operator">==</span> <span class="token string">&quot;80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000200000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="node-discovery-protocol-v5"><a href="#node-discovery-protocol-v5" class="header-anchor">#</a> Node Discovery Protocol v5</h2> <h3 id="introduction-4"><a href="#introduction-4" class="header-anchor">#</a> Introduction</h3> <p>The <code>eth/p2p/discoveryv5</code> directory holds a Nim implementation of the
<a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md" target="_blank" rel="noopener noreferrer">Node Discovery Protocol v5.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>The implemented specification is Protocol version v5.1.</p> <p>This implementation does not support &quot;Topic Advertisement&quot; yet as this part of
the specification is not complete.</p> <p>The implementation depends on other modules in the <code>eth</code> package, namely: <code>keys</code>
and <code>rlp</code>.</p> <h3 id="how-to-use"><a href="#how-to-use" class="header-anchor">#</a> How to use</h3> <div class="language-Nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">let</span>
  rng <span class="token operator">=</span> keys<span class="token operator">.</span>newRng
  privKey <span class="token operator">=</span> PrivateKey<span class="token operator">.</span><span class="token function">random</span><span class="token punctuation">(</span>rng<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> tcpPort<span class="token punctuation">,</span> udpPort<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">setupNat</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token comment"># Or fill in external IP/ports manually</span>
  d <span class="token operator">=</span> <span class="token function">newProtocol</span><span class="token punctuation">(</span>privKey<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> tcpPort<span class="token punctuation">,</span> udpPort<span class="token punctuation">,</span> rng <span class="token operator">=</span> rng<span class="token punctuation">)</span>

d<span class="token operator">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Start listening</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This will initialize the <code>Protocol</code> and start listening. However, as no
bootstrap nodes were passed in the <code>newProtocol</code> call, the created ENR will need
to be advertised somehow (&quot;out of band&quot;), so that the node can become known to
other nodes in the network.</p> <p>To initialize with a bootnode or a set of bootnodes, the ENRs need to be passed
as parameter in <code>newProtocol</code>.</p> <div class="language-Nim line-numbers-mode"><pre class="language-nim"><code>d <span class="token operator">=</span> <span class="token function">newProtocol</span><span class="token punctuation">(</span>privKey<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> tcpPort<span class="token punctuation">,</span> udpPort<span class="token punctuation">,</span>
      bootstrapRecords <span class="token operator">=</span> bootnodes<span class="token punctuation">)</span>
d<span class="token operator">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Start listening and add bootstrap nodes to the routing table.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Next there are two ways to run the protocol.</p> <p>One can call <code>d.start()</code> and two loops will be started:</p> <ol><li>Refresh loop</li> <li>Revalidation loop</li></ol> <p>The first loop will at specific interval do a query with a random <code>NodeId</code> if no
manual queries were done for more than that interval period.
This query will add discovered nodes to the routing table.
The second loop will at random ranged interval send a ping to the least recently
seen node in a random bucket. This is to keep the routing table cleared of
unreachable/dead nodes.</p> <p>Now within the application, manual queries or lookups can be done, for which
the discovered nodes can be used. Nodes discovered during this process will be
attempted to be added to the routing table. One can use the <code>query</code>, <code>queryRandom</code>
or <code>lookup</code> calls for this. <code>randomNodes</code> can also be used to find nodes,
but this will only look into the current routing table and not actively
search for nodes on the network.</p> <p>Or, one can decide not to run <code>d.start()</code> and do this manually within its
application by using the available calls:</p> <ul><li><code>query</code>, <code>queryRandom</code> or <code>lookup</code> for discovering more peers.</li> <li><code>revalidateNode</code> or directly <code>ping</code> for revalidating nodes.</li></ul> <p>Of course, in either scenario, lookups can still be done for actually finding a
specific node. There is a <code>resolve</code> call that can help with this, it will first
look in the local routing table and if it finds the node it will try to contact
the node directly to check if the ENR is up to date. If any of this fail a
<code>lookup</code> will be done.</p> <h3 id="test-suite"><a href="#test-suite" class="header-anchor">#</a> Test suite</h3> <p>To run the test suite specifically for discovery v5 related (discovery v5 + its
nim-eth dependencies) tests, one can run following command:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## Install required modules</span>
nimble <span class="token function">install</span>
<span class="token comment">## Run only discovery v5 related test suite</span>
nimble test_discv5_full
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="dcli"><a href="#dcli" class="header-anchor">#</a> dcli</h3> <p>This is a small command line application that allows you to run a discovery
node. It also has the options to do a <code>ping</code> or <code>findNode</code> request to a specific
node, by providing its ENR.</p> <h4 id="example-usage"><a href="#example-usage" class="header-anchor">#</a> Example usage</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## Install required modules</span>
<span class="token comment">## Make sure you have the latest modules, do NOT trust nimble on this.</span>
nimble <span class="token function">install</span>
<span class="token comment">## Build dcli</span>
nim c -d:chronicles_log_level:trace -d:release --threads:on ./tools/dcli
<span class="token comment">## See all options</span>
./tools/dcli --help
<span class="token comment">## Ping another node</span>
./tools/dcli <span class="token function">ping</span> enr:<span class="token operator">&lt;</span>base64 encoding of ENR<span class="token operator">&gt;</span>
<span class="token comment">## Run discovery node</span>
./tools/dcli --log-level:debug --bootnode:enr:<span class="token operator">&lt;</span>base64 encoding of ENR<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="metrics"><a href="#metrics" class="header-anchor">#</a> Metrics</h4> <p>To run dcli with metrics enabled provide the <code>metrics</code> flag:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">## Run dcli with metrics</span>
./tools/dcli --metrics --bootnode:enr:<span class="token operator">&lt;</span>base64 encoding of ENR<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>You can now see the metrics at http://localhost:8008/metrics. Or use e.g.
Prometheus to grab the data.</p> <h2 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h2> <ul><li>Nim &amp; Nimble</li></ul> <h2 id="building-testing"><a href="#building-testing" class="header-anchor">#</a> Building &amp; Testing</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code># Install required modules
nimble install
# Run full test suite
nimble test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>You can also run specific parts of the test suite, e.g.:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># Test p2p functionality
nimble test_p2p
# Test rlp functionality
nimble test_rlp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="fuzzing"><a href="#fuzzing" class="header-anchor">#</a> Fuzzing</h2> <p>Next to the test suite, there are also several fuzzing test cases available.
How these can be run is explained in the <a href="https://github.com/status-im/nim-eth/blob/master/tests/fuzzing/readme.md" target="_blank" rel="noopener noreferrer">fuzzing readme<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7b0ccc3e.js" defer></script><script src="/assets/js/2.19ed51f2.js" defer></script><script src="/assets/js/10.7ff41305.js" defer></script>
  </body>
</html>
